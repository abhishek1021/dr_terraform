name: Bootstrap Terraform Backend

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap (dr, stage, prod)'
        required: true
        type: choice
        options:
          - dr
          - stage
          - prod
      action:
        description: 'Bootstrap action'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - destroy

permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'us-east-1'
  role-session-name: "gh-bootstrap-${{ github.run_id }}"

jobs:
  bootstrap:
    name: Bootstrap Backend Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}-bootstrap
    
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Install Terraform Binary
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Assume AWS Role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', github.event.inputs.environment)] }}
          role-session-name: ${{ env.role-session-name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init (Bootstrap)
        working-directory: ./bootstrap
        run: terraform init

      - name: Terraform Plan (Bootstrap)
        working-directory: ./bootstrap
        run: |
          terraform plan \
            -var-file="terraform.tfvars.${{ github.event.inputs.environment }}" \
            -out=bootstrap-plan

      - name: Terraform Apply (Bootstrap)
        if: github.event.inputs.action == 'create'
        working-directory: ./bootstrap
        run: terraform apply -auto-approve bootstrap-plan

      - name: Get Bootstrap Outputs
        if: github.event.inputs.action == 'create'
        working-directory: ./bootstrap
        id: outputs
        run: |
          BUCKET_NAME=$(terraform output -raw s3_bucket_name)
          DYNAMODB_TABLE=$(terraform output -raw dynamodb_table_name)
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "dynamodb_table=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
          echo "### ðŸŽ‰ Bootstrap Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**DynamoDB Table:** \`$DYNAMODB_TABLE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Update \`backend-configs/${{ github.event.inputs.environment }}.hcl\` with bucket name: \`$BUCKET_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Commit and push the updated backend config" >> $GITHUB_STEP_SUMMARY
          echo "3. Your main CI/CD pipeline will now use remote state!" >> $GITHUB_STEP_SUMMARY

      - name: Update Backend Config File
        if: github.event.inputs.action == 'create'
        run: |
          cat > backend-configs/${{ github.event.inputs.environment }}.hcl << EOF
          bucket         = "${{ steps.outputs.outputs.bucket_name }}"
          key            = "${{ github.event.inputs.environment }}/terraform.tfstate"
          region         = "${{ env.AWS_REGION }}"
          dynamodb_table = "${{ steps.outputs.outputs.dynamodb_table }}"
          encrypt        = true
          EOF

      - name: Create Pull Request with Backend Config
        if: github.event.inputs.action == 'create'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update backend config for ${{ github.event.inputs.environment }} environment"
          title: "Bootstrap: Update backend config for ${{ github.event.inputs.environment }}"
          body: |
            ## ðŸš€ Bootstrap Complete for ${{ github.event.inputs.environment }} Environment
            
            This PR updates the backend configuration with the newly created infrastructure:
            
            - **S3 Bucket:** `${{ steps.outputs.outputs.bucket_name }}`
            - **DynamoDB Table:** `${{ steps.outputs.outputs.dynamodb_table }}`
            
            ### What Changed:
            - Updated `backend-configs/${{ github.event.inputs.environment }}.hcl` with actual resource names
            
            ### Next Steps:
            1. Review and merge this PR
            2. Your main CI/CD pipeline will now use remote state storage
            3. Future Terraform operations will be stored in S3 with state locking
            
            **Auto-generated by Bootstrap workflow**
          branch: bootstrap/${{ github.event.inputs.environment }}-backend-config
          delete-branch: true

      - name: Terraform Destroy (Bootstrap)
        if: github.event.inputs.action == 'destroy'
        working-directory: ./bootstrap
        run: |
          terraform destroy \
            -var-file="terraform.tfvars.${{ github.event.inputs.environment }}" \
            -auto-approve

      - name: Clear AWS Credentials
        if: always()
        run: |
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
